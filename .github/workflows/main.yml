name: PLAYLIST_EPG Generator

# 定时触发（每天凌晨3点运行，时区为UTC，对应北京时间11点；如需北京时间3点，设置为 19:00）
on:
  push:
    # 指定要监听的分支（多个分支用数组，如 ['main', 'dev']）
    branches: [ "main" ]
  schedule:
    - cron: '0 20 * * *'  # UTC时间20点 = 北京时间凌晨4点
  # 手动触发
  workflow_dispatch:

# 权限配置
permissions:
  contents: write  # 允许写入仓库内容（用于上传生成的文件）

jobs:
  generate-playlist-epg:
    runs-on: ubuntu-latest
    
    steps:
      # 步骤1：检出代码
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 步骤2：设置Python环境
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 新增步骤：安装Python依赖（关键修复）
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests  # 安装脚本所需的requests库
      
      # 步骤3：运行PLAYLIST-EPG生成脚本
      - name: Run PLAYLIST-EPG generator
        run: |
          python main.py all
      
      # 步骤4：上传生成的文件到GitHub Releases（可选）
      #- name: Upload PLAYLIST-EPG files to Release
     #   uses: softprops/action-gh-release@v2
     #   with:
     #     tag_name: playlist-epg-latest
     #     name: PLAYLIST-EPG Latest Build (${{ github.run_id }})
     #     body: |
     #       自动生成的PLAYLIST-EPG文件
     #       - 生成时间：${{ github.run_at }}
     #       - 运行ID：${{ github.run_id }}
     #     files: |
     #       playlist.m3u
     #       epg.xml
     #       epg.xml.gz
    #        
    #      overwrite: true  # 覆盖同名tag的release
    #    if: success()  # 仅在脚本运行成功时执行
      
      # 步骤5：推送生成的文件到仓库（可选，替代Release）
      - name: Push files to repository
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add playlist.m3u epg.xml epg.xml.gz
          git commit -m "Update PLAYLIST-EPG files - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        if: success()
        continue-on-error: true  # 推送失败不影响整体流程
